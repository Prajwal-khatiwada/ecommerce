<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Haat Bazar</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="search.css">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <div id="userCart">
      <a href="cartable.html">Here Cart</a>
      <script src="userCart.js"></script>
    </div>

    <div id="userStatus">
      <!-- This div will be updated with the username or login option -->
    </div>

    <script>
      // Check if the user is logged in
      var token = localStorage.getItem("token");
      var username = localStorage.getItem("username");

      // Get the userStatus div where we will display the username or login option
      var userStatusDiv = document.getElementById("userStatus");

      if (token && username) {
        // User is logged in, display their username
        userStatusDiv.innerHTML =
          "Welcome, " + username + "! (<a href='#' id='logoutLink'>Logout</a>)";

        // Add a logout event listener
        var logoutLink = document.getElementById("logoutLink");
        logoutLink.addEventListener("click", function () {
          // Clear the stored user information
          localStorage.removeItem("token");
          localStorage.removeItem("username");
          localStorage.removeItem("userID");

          // Redirect to the login page or perform other actions as needed
          window.location.href = "login.html";
        });
      } else {
        // User is not logged in, display a login link
        userStatusDiv.innerHTML =
          "Please <a href='login.html'>login</a> to access your account.";
      }
    </script>
    <section id="header">
      <div class="logo">
        <a href=""><img src="img\logo_site.png" alt="Logo" /></a>
      </div>
      
      <div class="search">
        <div class="search-dropdown">
          <input
            id="searchInput"
            type="text"
            placeholder="I'm searching for....."
          />
          <select id="categoryDropdown">
            <option value="Jewelry">Jewelry</option>
            <option value="Thanka">Thanka</option>
            <!-- Add more category options as needed -->
          </select>
          <div class="search-dropdown-content" id="searchDropdown"></div>
        </div>
      </div>

      <div>
        <ul id="navbar">
          <li><a class="active" href="index.html">Home</a></li>
          <li><a href="shop.html">Shop</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="#" id="open-cart">Cart</a></li>
        </ul>
      </div>
    </section>
    <section id="hero">
      <h4>हाट बजार</h4>
      <h1>नेपालमा बनेको नेपालीकै लगी।</h1>
      <p>A True Nepali E-Commerce</p>
      <button onclick="window.location.href='signup.html'">Shop Now</button>
    </section>

    <section id="gyapu" class="section-p1">
      <div class="ban">
        <img
          src="img/16E7B2623BB904C-1000 Ma Bazar - Is live Now-01.png"
          alt=""
        />
      </div>
    </section>

    <section id="product1" class="section-1">
      <h2>Featured Products</h2>
      <p>Collection New Modern Products</p>
      <div class="container">
        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star">
            <!-- Star icons will be added here dynamically -->
          </div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>

        <div class="pro">
          <img src="" alt="Product Image" class="product-image" />
          <div class="des">
            <span class="product-category"></span>
            <h5 class="product-name"></h5>
            <h4 class="product-price"></h4>
          </div>
          <div class="star"></div>
          <div class="cart1">
            <a
              href="javascript:void(0);"
              class="add-to-cart-button"
              data-product-id=""
            >
              <i class="fa fa-shopping-cart cart" aria-hidden="true"></i>
            </a>
          </div>
        </div>
      </div>
      <section id="banner">
        <h4>Repair Services</h4>
        <h2>Up to <span> 70% Off</span> - ALL T-shirts</h2>
        <button class="normal">Explore More</button>
      </section>

      <section id="banner3">
      <div class="banner-box b3">
        <h2>SEASONAL SALE</h2>
        <h3>Winter Collection - 50% Off</h3>
      </div>
      <div class="banner-box b4">
        <h2>NEW FOOTWEAR COLLECTION</h2>
        <h3>Spring/Summer 2022</h3>
      </div>
      <div class="banner-box b5">
        <h2>T-SHIRTS</h2>
        <h3>New Trendy Prints</h3>
      </div>
    </section>
    <section id="newsletter">
      <div class="newstext">
        <h4>Sign up For Newsletters</h4>
        <p>
          Get E-mail updates about our latest shop and
          <span>special offers</span>
        </p>
      </div>
      <div class="form">
        <input type="text" placeholder="Your E-mail Address" />
        <button class="normal">Sign Up</button>
      </div>
    </section>

    <footer class="section-p1">
      <div class="col col1">
        <div class="logo logo1">Haat Bazar</div>
        <h4>Contact</h4>
        <p><strong>Address:</strong> Bhaktapur, Nepal</p>
        <p><strong>Phone:</strong> +977-9800000000</p>
        <p><strong>Hours:</strong> 5pm - 5pm, Sun-Fri</p>
        <div class="follow">
          <h4>Follow us</h4>
          <div class="icon">
            <i class="fab fa-facebook"></i>
            <i class="fab fa-instagram"></i>
            <i class="fab fa-youtube"></i>
            <i class="fab fa-twitter"></i>
          </div>
        </div>
      </div>
      <div class="col">
        <h4>About</h4>
        <a href="">About us</a>
        <a href="">Delivery Information</a>
        <a href="">Privacy Policy</a>
        <a href="">Terms & Conditions</a>
        <a href="">Contact us</a>
      </div>

      <div class="col">
        <h4>My Account</h4>
        <a href="">Sign In</a>
        <a href="">View Cart</a>
        <a href="">My Wishlist</a>
        <a href="">Track My Order</a>
        <a href="">Help</a>
      </div>

      <div class="col install">
        <h4>Install App</h4>
        <p>From App Store or Google Play</p>
        <div class="row">
          <img src="img/pay/app.jpg" alt="" />
          <img src="img/pay/play.jpg" alt="" />
        </div>
        <p>Secure Payment Gate way</p>
        <img src="img/pay/pay.png" />
      </div>
    </footer>
    <div class="copyright">
      <p>@2023- Designed By Haat Bazar</p>
    </div>

    <div id="popup-cart" class="hidden">
      <div id="close-cart" class="close-button">X</div>
      <h2>Your Cart</h2>
      <div id="cart-container">
        <!-- Cart items will be displayed here dynamically -->
      </div>
      <p id="total-price">Total: $0.00</p>
      <button onclick="checkout()">Checkout</button>
      <button onclick="guestCheckout()">Guest Checkout</button>
    </div>

    <script>
      // Function to generate star icons based on the product's rating
      function generateStarRatings(rating) {
        const starRatings = document.createElement("div");
        starRatings.className = "star";

        for (let i = 1; i <= 5; i++) {
          const star = document.createElement("i");
          star.className = `fas fa-star${i <= rating ? " active" : ""}`;
          starRatings.appendChild(star);
        }

        return starRatings;
      }

      function addToCart(productId) {
        const userId = localStorage.getItem("userID");
        const token = localStorage.getItem("token");

        if (!userId || !token) {
          console.log("User not logged in or token missing");
          return;
        }

        // Make a request to add the product to the cart
        fetch(
          `http://localhost:8000/addtocart?id=${productId}&userID=${userId}`,
          {
            method: "GET",
            headers: {
              Token: `${token}`,
            },
            // mode: "no-cors"
          }
        )
          .then((response) => {
            if (response.status === 200) {
              console.log("Product added to cart successfully");
              // You can update the cart UI or perform other actions as needed
              console.log("Response from server:", data);
            } else {
              console.error("Failed to add product to cart");
            }
          })
          .catch((error) => {
            console.error("Error adding product to cart:", error);
          });
      }

      // Fetch product data and populate the placeholders
      fetch("http://localhost:8000/users/productview")
        .then((response) => response.json())
        .then((products) => {
          const productElements = document.querySelectorAll(".pro");

          products.forEach((product, index) => {
            const productElement = productElements[index];
            const productImage = productElement.querySelector(".product-image");
            const productCategory =
              productElement.querySelector(".product-category");
            const productName = productElement.querySelector(".product-name");
            const productPrice = productElement.querySelector(".product-price");
            const starRatings = productElement.querySelector(".star");
            const addToCartButton = productElement.querySelector(
              ".add-to-cart-button"
            );

            productImage.src = product.image;
            productCategory.textContent = product.category[0]; // Assuming there's only one category
            productName.textContent = product.product_name;
            productPrice.textContent = `$${product.price}`;

            // Extract and set the Product_ID in the data-product-id attribute
            addToCartButton.setAttribute("data-product-id", product.Product_ID);

            // Generate and append star ratings
            if (starRatings) {
              const rating = product.rating;
              starRatings.appendChild(generateStarRatings(rating));
            }
          });
        })
        .catch((error) => {
          console.error("Error fetching product data:", error);
        });

      // Add event listeners to "Add to Cart" buttons
      const addToCartButtons = document.querySelectorAll(".add-to-cart-button");
      addToCartButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const productId = button.getAttribute("data-product-id");
          if (productId) {
            addToCart(productId);
          }
        });
      });

      // Function with search and addtocart
        function addToCart(productId, productName) {
          console.log(
            "Adding product to cart (ID:",
            productId,
            "Name:",
            productName,
            ")"
          );
          const userId = localStorage.getItem("userID");
          const token = localStorage.getItem("token");
  
          console.log(userId);
          console.log(token);
  
          if (!userId || !token) {
            console.log("User not logged in or token missing");
            return;
          }
  
          fetch(
            `http://localhost:8000/addtocart?id=${productId}&userID=${userId}`,
            {
              method: "GET",
              headers: {
                Token: `${token}`,
              },
              // mode: "no-cors"
            }
          )
            .then((response) => {
              if (response.status === 200) {
                console.log("Product added to cart successfully");
                console.log("Response from server:", data);
              } else {
                console.error("Failed to add product to cart");
              }
            })
            .catch((error) => {
              console.error("Error adding product to cart:", error);
            });
        }
  
        $(document).ready(function () {
          var searchDropdown = $("#searchDropdown");
  
          $("#searchInput").keyup(function () {
            var query = $("#searchInput").val();
  
            $.ajax({
              type: "GET",
              url: "http://localhost:8000/users/search?name=" + query,
              success: function (data) {
                searchDropdown.empty();
  
                if (data.length > 0) {
                data.forEach(function (result) {
                  var resultItem = $("<a>").text(result.product_name);
                  var priceLabel = $("<span>")
                    .addClass("search-result-price")
                    .text(" Rs. " + result.price);
                  resultItem.append(priceLabel);

                  var imageLabel = $("<img>")
                    .addClass("search-result-image")
                    .attr("src", result.image)
                  resultItem.append(imageLabel)

                  resultItem.click(function () {
                    addToCart(result.Product_ID, result.product_name);
                    searchDropdown.css("display", "none");
                  });
                  searchDropdown.append(resultItem);
                });

                searchDropdown.css("display", "block");
              } else {
                searchDropdown.css("display", "none");
              }
              },
              error: function (error) {
                console.log("Error: " + error);
              },
            });
          });
  
          $(document).click(function (e) {
            if (!$(e.target).closest(".search-dropdown").length) {
              searchDropdown.css("display", "none");
            }
          });
        });

        $(document).ready(function () {
          var searchDropdown = $("#searchDropdown");
  
          $("#searchInput, #categoryDropdown").on("input", function () {
            var query = $("#searchInput").val();
            var category = $("#categoryDropdown").val();
  
            $.ajax({
              type: "GET",
              url: `http://localhost:8000/users/search-category?name=${category}`,
              success: function (data) {
                searchDropdown.empty();
  
                if (data.length > 0) {
                data.forEach(function (result) {
                  var resultItem = $("<a>").text(result.product_name);
                  var priceLabel = $("<span>")
                    .addClass("search-result-price")
                    .text(" Rs. " + result.price);
                  resultItem.append(priceLabel);

                  var imageLabel = $("<img>")
                    .addClass("search-result-image")
                    .attr("src", result.image)
                  resultItem.append(imageLabel)

                  resultItem.click(function () {
                    addToCart(result.Product_ID, result.product_name);
                    searchDropdown.css("display", "none");
                  });
                  searchDropdown.append(resultItem);
                });

                searchDropdown.css("display", "block");
              } else {
                searchDropdown.css("display", "none");
              }
              },
              error: function (error) {
                console.log("Error: " + error);
              },
            });
          });
  
          $(document).click(function (e) {
            if (!$(e.target).closest(".search-dropdown").length) {
              searchDropdown.css("display", "none");
            }
          });
        });
      </script>
    </script>
  </body>
</html>
